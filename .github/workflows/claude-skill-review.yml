name: Claude Skill Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to review'
        required: true
        type: number

jobs:
  detect-skills:
    runs-on: ubuntu-latest
    outputs:
      skills: ${{ steps.detect.outputs.skills }}
      has_skills: ${{ steps.detect.outputs.has_skills }}
      pr_number: ${{ steps.pr-info.outputs.pr_number }}
      base_ref: ${{ steps.pr-info.outputs.base_ref }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR info
        id: pr-info
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "pr_number=${{ inputs.pr_number }}" >> $GITHUB_OUTPUT
            echo "base_ref=main" >> $GITHUB_OUTPUT
          else
            echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
            echo "base_ref=${{ github.base_ref }}" >> $GITHUB_OUTPUT
          fi

      - name: Checkout PR branch
        if: github.event_name == 'workflow_dispatch'
        run: gh pr checkout ${{ inputs.pr_number }}
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Detect skill changes
        id: detect
        run: |
          # Get changed files in this PR
          changed_files=$(git diff --name-only origin/${{ steps.pr-info.outputs.base_ref }}...HEAD)

          # Find all skill directories (directories containing SKILL.md)
          skill_dirs=$(find . -name "SKILL.md" -type f | xargs -I {} dirname {} | sed 's|^\./||')

          # Find which skills have changes
          affected_skills=()
          for skill_dir in $skill_dirs; do
            for file in $changed_files; do
              if [[ "$file" == "$skill_dir"* ]]; then
                affected_skills+=("$skill_dir")
                break
              fi
            done
          done

          # Remove duplicates and convert to JSON array
          if [ ${#affected_skills[@]} -gt 0 ]; then
            unique_skills=$(printf '%s\n' "${affected_skills[@]}" | sort -u | jq -R -s -c 'split("\n") | map(select(length > 0))')
            echo "skills=$unique_skills" >> $GITHUB_OUTPUT
            echo "has_skills=true" >> $GITHUB_OUTPUT
            echo "Affected skills: $unique_skills"
          else
            echo "skills=[]" >> $GITHUB_OUTPUT
            echo "has_skills=false" >> $GITHUB_OUTPUT
            echo "No skill changes detected"
          fi

  review-skill:
    needs: detect-skills
    if: needs.detect-skills.outputs.has_skills == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        skill: ${{ fromJson(needs.detect-skills.outputs.skills) }}
      fail-fast: false
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout PR branch
        if: github.event_name == 'workflow_dispatch'
        run: gh pr checkout ${{ needs.detect-skills.outputs.pr_number }}
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Get changed files for this skill
        id: skill-files
        run: |
          changed_files=$(git diff --name-only origin/${{ needs.detect-skills.outputs.base_ref }}...HEAD | grep "^${{ matrix.skill }}" || true)
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$changed_files" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run Claude Skill Review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          plugin_marketplaces: 'https://github.com/anthropics/agent-skills.git'
          plugins: 'skill-creator@anthropic-agent-skills'
          prompt: |
            Review the changes to the **${{ matrix.skill }}** skill in PR ${{ github.repository }}/pull/${{ needs.detect-skills.outputs.pr_number }}.

            Changed files in this skill:
            ${{ steps.skill-files.outputs.files }}

            Use the skill-creator skill guidelines to evaluate this skill.

            Structure your review in two sections:

            **Skill Review**: Evaluate the skill as a whole against skill-creator best practices.

            **PR-Specific Feedback**: Call out any issues that are specifically introduced or addressed by the changes in this PR.
